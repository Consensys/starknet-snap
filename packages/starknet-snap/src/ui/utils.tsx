import { DialogType } from '@metamask/snaps-sdk';

import type { TransactionRequest } from '../types/snapState';
import type { ExecuteTxnUIErrors } from './components';
import { ExecuteTxnUI } from './components';

/**
 *
 * @param options0
 * @param options0.children
 */
export async function alertDialog({ children }) {
  return await snap.request({
    method: 'snap_dialog',
    params: {
      type: DialogType.Alert,
      content: children,
    },
  });
}

/**
 *
 * @param options0
 * @param options0.children
 */
export async function confirmDialog({ children }) {
  return await snap.request({
    method: 'snap_dialog',
    params: {
      type: DialogType.Confirmation,
      content: children,
    },
  });
}

/**
 * Generate the interface for the execute transaction flow.
 *
 * This function creates a UI interface for a specific transaction flow by dynamically rendering
 * the provided React component with the given props. The component and props are passed as parameters,
 * ensuring type safety and flexibility for various transaction flows.
 *
 * @template Props - The type of props expected by the React component.
 * @param Component - The React component to render, which is expected to handle the UI for the transaction flow.
 * It should accept props of type `Props`.
 * @param request - An object containing the properties required by the `Component` along with an `id` field.
 * The `request` object must match the props expected by the `Component`.
 * @returns A Promise that resolves to the interface ID generated by the Snap request.
 * The ID can be used for tracking or referencing the created interface.
 */
export async function generateFlow<Props>(
  Component: React.ComponentType<Props>, // Generic Component expecting props of type P
  request: Props & { id: string }, // Request must match props and include an `id`
) {
  return await snap.request({
    method: 'snap_createInterface',
    params: {
      ui: <Component {...request} />,
      context: {
        id: request.id,
      },
    },
  });
}

/**
 * Updates the transaction flow interface.
 *
 * This function updates the UI for a transaction flow using a provided React component and its associated props.
 * It dynamically renders the updated UI and associates it with the specified interface ID.
 *
 * @template Props - The type of props expected by the React component.
 * @param Component - The React component to render, representing the updated UI for the transaction flow.
 * It should accept props of type `Props`.
 * @param params - The parameters for the transaction flow update.
 * Must include `interfaceId` for referencing the current flow and `id` for context.
 * @param params.interfaceId - The unique identifier for the existing interface to update.
 * @param errors - Optional errors to display in the updated interface.
 * @returns A Promise that resolves when the interface has been successfully updated.
 */
export async function updateFlow<Props>(
  Component: React.ComponentType<Props>, // Generic Component expecting props of type Props
  params: Props & { id: string; interfaceId: string }, // Props must include `id` and `interfaceId`
  errors?: Partial<Props>, // Optional partial props for error handling or overrides
) {
  // Perform the interface update
  await snap.request({
    method: 'snap_updateInterface',
    params: {
      id: params.interfaceId,
      ui: <Component {...params} {...errors} />,
    },
  });
}

/**
 * Generate the execute transaction flow interface.
 *
 * @param params - The parameters for the transaction execution flow.
 * @param params.id - The unique identifier for the transaction flow context.
 * @param params.type - The type of transaction to be executed.
 * @param params.signer - The signer for the transaction.
 * @param params.chainId - The ID of the blockchain network.
 * @param params.maxFee - The maximum allowable fee for the transaction.
 * @param params.calls - The array of calls involved in the transaction.
 * @param params.feeToken - The token used to pay transaction fees.
 * @param params.includeDeploy - Indicates if account deployment should be included in the transaction.
 * @returns The interface ID generated by the Snap request.
 */
export async function generateExecuteTxnFlow({
  id,
  type,
  signer,
  chainId,
  maxFee,
  calls,
  feeToken,
  includeDeploy,
}: TransactionRequest) {
  return await snap.request({
    method: 'snap_createInterface',
    params: {
      ui: (
        <ExecuteTxnUI
          type={type}
          signer={signer}
          chainId={chainId}
          maxFee={maxFee}
          calls={calls}
          feeToken={feeToken}
          includeDeploy={includeDeploy}
        />
      ),
      context: {
        id,
      },
    },
  });
}

/**
 * Updates the execute transaction flow interface.
 *
 * @param params - The parameters for the transaction execution flow.
 * @param params.id - The unique identifier for the transaction flow context.
 * @param params.type - The type of transaction to be executed.
 * @param params.signer - The signer for the transaction.
 * @param params.chainId - The ID of the blockchain network.
 * @param params.maxFee - The maximum allowable fee for the transaction.
 * @param params.calls - The array of calls involved in the transaction.
 * @param params.feeToken - The token used to pay transaction fees.
 * @param params.includeDeploy - Indicates if account deployment should be included in the transaction.
 * @param params.interfaceId
 * @param errors
 * @returns The interface ID generated by the Snap request.
 */
export async function updateExecuteTxnFlow(
  {
    id,
    interfaceId,
    type,
    signer,
    chainId,
    maxFee,
    calls,
    feeToken,
    includeDeploy,
  }: TransactionRequest,
  errors?: ExecuteTxnUIErrors,
) {
  await snap.request({
    method: 'snap_updateInterface',
    params: {
      id: interfaceId,
      ui: (
        <ExecuteTxnUI
          type={type}
          signer={signer}
          chainId={chainId}
          maxFee={maxFee}
          calls={calls}
          feeToken={feeToken}
          includeDeploy={includeDeploy}
          errors={errors}
        />
      ),
    },
  });
  return await snap.request({
    method: 'snap_createInterface',
    params: {
      ui: (
        <ExecuteTxnUI
          type={type}
          signer={signer}
          chainId={chainId}
          maxFee={maxFee}
          calls={calls}
          feeToken={feeToken}
          includeDeploy={includeDeploy}
        />
      ),
      context: {
        id,
      },
    },
  });
}

export type UpdateInterfaceParams = {
  id: string;
  ui: JSX.Element;
};

/**
 *
 * @param id
 * @param ui
 */
export async function updateInterface(
  id: string,
  ui: JSX.Element,
): Promise<void> {
  await snap.request({
    method: 'snap_updateInterface',
    params: {
      id,
      ui,
    },
  });
}
